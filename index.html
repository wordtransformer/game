<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Transformations — Daily</title>
<meta name="description" content="Change one letter per move. One daily start word. Score one point per valid transformation.">
<style>
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --text:#1b1f29; --muted:#58627a; --border:#e3e7ef;
    --accent:#0b84ff; --accent-2:#ff6a00; --ok:#10b981; --bad:#ef4444; --hint:#0b84ff; --warn:#ffb020;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;display:grid;grid-template-rows:auto 1fr}
  header{padding:12px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:12px}
  main{display:grid;place-items:center;padding:10px}
  .board{width:100%;max-width:720px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;display:grid;gap:12px;position:relative}
  .topline{display:grid;grid-template-columns:1fr auto;align-items:end}
  .bigmax{font-size:28px;font-weight:900;letter-spacing:.4px}
  .status{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .stat{background:#f2f5fb;border:1px solid var(--border);border-radius:12px;padding:8px;display:grid;gap:2px;place-items:center}
  .stat .n{font-size:18px;font-weight:800}
  .small{font-size:12px;color:var(--muted)}
  .progress{width:100%;height:8px;border-radius:999px;background:#eef2f9;overflow:hidden;border:1px solid var(--border)}
  .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .25s ease}
  .bar{text-align:center;font-size:12px;color:var(--muted)}
  .game-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:620px){.game-row{grid-template-columns:1fr}}
  .word-box,.entry{display:grid;gap:6px;background:#f7faff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .word{font-weight:900;letter-spacing:2px;font-size:28px;text-align:center}
  .word.danger{color:var(--bad)}
  input[type="text"]{width:100%;background:#fff;color:var(--text);border:2px solid var(--accent);border-radius:12px;padding:12px;font-size:18px;letter-spacing:1px;outline:none}
  input[type="text"]:focus{box-shadow:0 0 0 3px rgba(11,132,255,.25)}
  .buttons{display:grid;grid-auto-flow:column;gap:8px;justify-content:center}
  button{background:#e9f2ff;color:#0b2470;border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700}
  button.primary{background:var(--accent);color:#fff;border:0}
  .msg{min-height:18px}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .chain{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;max-height:180px;overflow:auto}
  @media (max-width:580px){.chain{grid-template-columns:repeat(4,1fr)}}
  .pill{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:8px 6px;font-weight:800;font-size:14px;letter-spacing:1px;text-align:center}
  .hintline{min-height:20px;font-size:13px}
  .hint-ok{color:var(--ok)} .hint-warn{color:var(--warn)} .hint-bad{color:var(--bad)}
  .friendbox{display:grid;gap:6px;background:#f7faff;border:1px solid var(--border);border-radius:12px;padding:10px}
  .sharebar{display:grid;grid-auto-flow:column;gap:8px;justify-content:center;align-items:center}
  /* icon buttons */
  button.icon { display:inline-grid; grid-auto-flow:column; align-items:center; gap:6px; }
  button.icon svg{ width:18px; height:18px; display:block; }
  @media (max-width:480px){ button.icon span.label{ display:none; } }
  canvas#fx{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<header>
  <div>
    <h1>Transformations — Daily</h1>
    <div class="sub">Change one letter per move. One point per valid transformation</div>
  </div>
  <div class="sub" id="dateLabel"></div>
</header>

<main>
  <div class="board">
    <div class="topline">
      <div class="bigmax">Max possible chain today: <span id="bigMaxN">?</span></div>
      <div class="small">Progress</div>
    </div>

    <div class="status">
      <div class="stat"><div class="small">Score</div><div id="scoreN" class="n">0</div></div>
      <div class="stat"><div class="small">Start moves</div><div id="fromStartN" class="n">0</div></div>
      <div class="stat"><div class="small">Possible words</div><div id="remainN" class="n">0</div></div>
      <div class="stat"><div class="small">Best chain</div><div id="pbN" class="n">0</div></div>
      <div class="stat"><div class="small">Max today</div><div id="maxToday" class="n">?</div></div>
      <div class="stat">
        <div class="small">Countdown</div>
        <label><input id="timerSwitch" type="checkbox" class="switch"></label>
      </div>
    </div>

    <div class="progress"><div id="progFill"></div></div>
    <div class="bar" id="maxLine">Max today ?</div>
    <div class="bar" id="countDown" style="display:none">Next puzzle in 00:00:00</div>

    <div class="game-row">
      <div class="word-box">
        <div class="small">Current word</div>
        <div id="currentWord" class="word">?????</div>
      </div>
      <div class="entry">
        <div class="small">Your next word</div>
        <input id="guess" type="text" maxlength="5" inputmode="latin" autocomplete="off" autocapitalize="none" placeholder="Enter next word">
        <div class="buttons">
          <button id="enterBtn" class="primary">Enter</button>
          <button id="endBtn">End</button>
          <button id="resetBtn">Reset</button>
          <button id="dictModeBtn" title="Broader word list">Lenient: Off</button>
        </div>
        <div id="hint" class="hintline"></div>
        <div id="msg" class="small msg"></div>
      </div>
    </div>

    <div class="small">Your chain</div>
    <div id="chain" class="chain"></div>

    <div class="sharebar">
      <button id="copyBtn" class="icon" aria-label="Copy share">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
        <span class="label">Copy</span>
      </button>

      <button id="webshareBtn" class="icon" aria-label="Share">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 8a3 3 0 0 0-2.82 2H8.82a3 3 0 0 0 0 4h6.36A3 3 0 1 0 18 8zm-12 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4zM18 10a2 2 0 1 1 0 4 2 2 0 0 1 0-4z"/></svg>
        <span class="label">Share…</span>
      </button>

      <button id="xBtn" class="icon" aria-label="Share to X">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2H21L14.36 9.57 22 22h-6.244l-4.66-7.26L5.6 22H3l7.18-8.28L2 2h6.31l4.2 6.63L18.244 2zM7.42 3.5H5.53l11.07 17h1.89l-11.07-17z"/></svg>
        <span class="label">X</span>
      </button>

      <button id="fbBtn" class="icon" aria-label="Share to Facebook">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07C2 17.1 5.66 21.21 10.44 22v-7.03H7.9v-2.9h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.23.2 2.23.2v2.45h-1.26c-1.24 0-1.63.77-1.63 1.56v1.87h2.78l-.44 2.9h-2.34V22C18.34 21.21 22 17.1 22 12.07z"/></svg>
        <span class="label">Facebook</span>
      </button>

      <button id="storyBtn" class="icon" aria-label="Story card">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v12.5a1.5 1.5 0 0 1-2.32 1.26l-2.92-1.95a2 2 0 0 0-2.22 0l-2.1 1.4a2 2 0 0 1-2.22 0l-2.92-1.95A1.5 1.5 0 0 0 3 17.5V5a2 2 0 0 1 2-2zm1.5 3A1.5 1.5 0 1 0 8 7.5 1.5 1.5 0 0 0 6.5 6z"/></svg>
        <span class="label">Story</span>
      </button>

      <button id="soundBtn" class="icon" aria-label="Toggle sound">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 10v4h4l5 5V5L7 10H3zm13.5 2a4.5 4.5 0 0 0-2.5-4v8a4.5 4.5 0 0 0 2.5-4zm-2.5-9.5v3a7.5 7.5 0 0 1 0 13v3a10.5 10.5 0 0 0 0-19z"/></svg>
        <span class="label">Sound on</span>
      </button>

      <select id="themePick" title="Theme">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="hc">High Contrast</option>
      </select>
    </div>

    <div class="friendbox">
      <div class="small">Friend leaderboard. Paste lines like: Transformations 2025-08-24  start SHINE  score 9  max 12  by Rob</div>
      <textarea id="friendInput" rows="3" placeholder="Paste friend score lines here"></textarea>
      <button id="friendParse">Build leaderboard</button>
      <div id="friendBoard" class="small"></div>
    </div>
  </div>
</main>

<canvas id="fx"></canvas>

<script>
/* configuration */
const SITE_URL = location.href.split('#')[0];
/* danger threshold: current word turns red when remaining next moves <= this */
const DANGER_THRESH = 2; // try 2 or 1

/* helpers */
const norm = s => (s||"").toLowerCase().trim();
const is5 = s => /^[a-z]{5}$/.test(s);
const ham1 = (a,b) => { if(a.length!==5||b.length!==5) return false; let d=0; for(let i=0;i<5;i++) if(a[i]!==b[i]) d++; return d===1; };
const ymd = () => { const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); };
function seededPick(arr, seedStr){ let h=0; for(let i=0;i<seedStr.length;i++) h=(h*131+seedStr.charCodeAt(i))>>>0; function rng(){ h=(h*1664525+1013904223)>>>0; return h/2**32; } return arr[Math.floor(rng()*arr.length)]; }

/* audio and confetti */
let soundOn = true;
const AudioFX = (()=> {
  let ctx;
  function ac(){ return ctx||(ctx=new (window.AudioContext||window.webkitAudioContext)()); }
  function tone(freq, dur, type="sine", gain=0.15){
    if(!soundOn) return;
    const a=ac(), o=a.createOscillator(), g=a.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(a.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.0001, a.currentTime+dur); o.stop(a.currentTime+dur);
  }
  function chord(fs=[392,494,587], dur=.25){ fs.forEach((f,i)=>tone(f, dur*(1.1-.15*i), i? "triangle":"sine", .12)); }
  function fanfare(){ chord([523,659,784], .35); setTimeout(()=>chord([659,784,988], .45), 180); }
  function buzz(){ tone(200,.05,"square",.12); setTimeout(()=>tone(180,.06,"square",.1),60); }
  return { chord, fanfare, buzz };
})();
const FX = (()=> {
  const cv = document.getElementById("fx"), cx = cv.getContext("2d");
  let running=false, parts=[];
  function resize(){ cv.width=innerWidth; cv.height=innerHeight; }
  addEventListener("resize",resize); resize();
  function burst(x,y,n=160){
    for(let i=0;i<n;i++){
      parts.push({x,y,vx:(Math.random()*2-1)*6,vy:Math.random()*-6-2,r:Math.random()*6+2,a:1,c:Math.random()<.5?"#0b84ff":"#ff6a00",spin:(Math.random()*2-1)*.2});
    }
    if(!running){ running=true; requestAnimationFrame(tick); }
  }
  function tick(){
    cx.clearRect(0,0,cv.width,cv.height);
    for(const p of parts){
      p.vy+=0.12; p.x+=p.vx; p.y+=p.vy; p.a*=0.985;
      cx.save(); cx.globalAlpha=p.a; cx.translate(p.x,p.y); cx.rotate(p.spin); cx.fillStyle=p.c;
      cx.beginPath(); cx.moveTo(-p.r,0); cx.lineTo(0,-p.r); cx.lineTo(p.r,0); cx.lineTo(0,p.r); cx.closePath(); cx.fill();
      cx.restore();
    }
    parts = parts.filter(p=>p.a>0.05 && p.y<cv.height+20);
    if(parts.length){ requestAnimationFrame(tick); } else { running=false; }
  }
  return { burst };
})();

/* theme */
const THEMES = {
  light: {'--bg':'#f7f8fb','--panel':'#ffffff','--text':'#1b1f29','--muted':'#58627a','--border':'#e3e7ef','--accent':'#0b84ff','--accent-2':'#ff6a00','--ok':'#10b981','--bad':'#ef4444'},
  dark: {'--bg':'#0f1116','--panel':'#151a24','--text':'#eaf1f8','--muted':'#9fb0c8','--border':'#263044','--accent':'#8bd2ff','--accent-2':'#ffa726','--ok':'#2ecc71','--bad':'#ff6b6b'},
  hc:   {'--bg':'#ffffff','--panel':'#ffffff','--text':'#000000','--muted':'#111111','--border':'#000000','--accent':'#000000','--accent-2':'#ff0000','--ok':'#007700','--bad':'#cc0000'}
};
function applyTheme(name){
  const t = THEMES[name] || THEMES.light;
  for (const k in t) document.documentElement.style.setProperty(k, t[k]);
  localStorage.setItem('tx_theme', name);
  const sel = document.getElementById('themePick'); if (sel) sel.value = name;
}

/* UI refs */
const ui = {
  date: document.getElementById("dateLabel"),
  score: document.getElementById("scoreN"),
  fromStart: document.getElementById("fromStartN"),
  remain: document.getElementById("remainN"),
  pb: document.getElementById("pbN"),
  maxToday: document.getElementById("maxToday"),
  current: document.getElementById("currentWord"),
  guess: document.getElementById("guess"),
  enter: document.getElementById("enterBtn"),
  end: document.getElementById("endBtn"),
  reset: document.getElementById("resetBtn"),
  chain: document.getElementById("chain"),
  msg: document.getElementById("msg"),
  maxLine: document.getElementById("maxLine"),
  progFill: document.getElementById("progFill"),
  timerSwitch: document.getElementById("timerSwitch"),
  countdown: document.getElementById("countDown"),
  copy: document.getElementById("copyBtn"),
  webshare: document.getElementById("webshareBtn"),
  x: document.getElementById("xBtn"),
  fb: document.getElementById("fbBtn"),
  story: document.getElementById("storyBtn"),
  sound: document.getElementById("soundBtn"),
  dictBtn: document.getElementById("dictModeBtn"),
  themePick: document.getElementById("themePick"),
  friendInput: document.getElementById("friendInput"),
  friendParse: document.getElementById("friendParse"),
  friendBoard: document.getElementById("friendBoard"),
  bigMaxN: document.getElementById("bigMaxN"),
  hint: document.getElementById("hint")
};

/* dictionary sources from the gist you shared, with fallbacks */
const GIST_LA = "https://gist.githubusercontent.com/scholtes/94f3c0303ba6a7768b47583aff36654d/raw/wordle-La.txt";
const GIST_TA = "https://gist.githubusercontent.com/scholtes/94f3c0303ba6a7768b47583aff36654d/raw/wordle-Ta.txt";
const TABATKINS = "https://raw.githubusercontent.com/tabatkins/wordle-list/main/words";
const EXTRA_URL = "https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt";

/* dictionary state */
const FALLBACK = Array.from(new Set([
  "about","above","adobe","adore","adorn","apple","amber","alone","alter",
  "blade","blame","blank","blink","brain","brand","bring","brink",
  "chair","chain","chime","chine","crime","cramp","crimp","craft","draft","drift",
  "glade","grade","grape","graph","graft","grain","grand","grant","groin","group",
  "shore","share","shave","shine","shins","short","shone","shove","store","stone","stony","stove",
  "spare","spike","spine","spiny","spore","spout","spoke","smoke","snake","spice",
  "thing","think","thank","other","which","their","these","would","could",
  "train","grain","brain","plane","flame","frame","blame","swine"
]));
let DICT_STD = FALLBACK.slice();     // Standard mode
let DICT_LENIENT = FALLBACK.slice(); // Lenient mode
let USE_LENIENT = false;

/* cache helpers */
function loadCache(key){ try{ return JSON.parse(localStorage.getItem(key)||"null"); } catch { return null; } }
function saveCache(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); } catch {} }

/* neighbor index */
let patterns = new Map();
function currentDict(){ return USE_LENIENT ? DICT_LENIENT : DICT_STD; }
function buildIndex(){
  const base = currentDict();
  patterns = new Map();
  for(const w of base){
    for(let i=0;i<5;i++){
      const pat = w.slice(0,i)+"*"+w.slice(i+1);
      if(!patterns.has(pat)) patterns.set(pat,[]);
      patterns.get(pat).push(w);
    }
  }
}
function neighborsOf(w){
  const byWord = new Set(currentDict());
  const out=new Set();
  for(let i=0;i<5;i++){
    const pat=w.slice(0,i)+"*"+w.slice(i+1);
    const list=patterns.get(pat)||[];
    for(const v of list) if(v!==w && byWord.has(v)) out.add(v);
  }
  return Array.from(out);
}
function dictIncludes(word){
  const key = USE_LENIENT? "len" : "std";
  if(!dictIncludes._sets) dictIncludes._sets={};
  if(!dictIncludes._sets[key]) dictIncludes._sets[key] = new Set(currentDict());
  return dictIncludes._sets[key].has(word);
}

/* load dictionaries in order: gist La+Ta, then Tabatkins, then extra for lenient */
async function loadDictionaries(){
  const c1 = loadCache("tx_dict_std_gist_v1");
  const c2 = loadCache("tx_dict_len_gist_v1");
  if(c1 && c2){ DICT_STD=c1; DICT_LENIENT=c2; buildIndex(); return; }

  let std = new Set(FALLBACK);
  let len = new Set(FALLBACK);

  async function addWordFile(url, targetSet){
    try{
      const res = await fetch(url, {mode:"cors"});
      if(!res.ok) return;
      const txt = await res.text();
      txt.split(/[\s\r\n]+/).map(norm).filter(is5).forEach(w=>targetSet.add(w));
    }catch{}
  }

  await addWordFile(GIST_LA, std);
  await addWordFile(GIST_TA, std);
  await addWordFile(GIST_LA, len);
  await addWordFile(GIST_TA, len);

  await addWordFile(TABATKINS, std);
  await addWordFile(TABATKINS, len);

  try{
    const res = await fetch(EXTRA_URL, {mode:"cors"});
    if(res.ok){
      const txt = await res.text();
      txt.split(/\r?\n/).forEach(w=>{ const v=norm(w); if(is5(v)) len.add(v); });
    }
  }catch{}

  DICT_STD = Array.from(std);
  DICT_LENIENT = Array.from(len);

  saveCache("tx_dict_std_gist_v1", DICT_STD);
  saveCache("tx_dict_len_gist_v1", DICT_LENIENT);

  buildIndex();
}

/* game state */
const state = { start:null, chain:[], used:new Set(), key:null, maxEstimate:null };

/* UI logic */
function subtleShake(el){
  el.animate([{transform:'translateX(0)'},{transform:'translateX(-2px)'},{transform:'translateX(2px)'},{transform:'translateX(0)'}],
             {duration:180, iterations:1});
}
function addPill(w, start=false){
  const div=document.createElement("div"); div.className="pill"; div.textContent=w.toUpperCase();
  if(start) div.title="start"; ui.chain.prepend(div);
}
function setCounts(word){
  const startMoves = neighborsOf(state.start).length;
  const currentMoves = neighborsOf(word).filter(v=>!state.used.has(v)).length;
  ui.fromStart.textContent = String(startMoves);
  ui.remain.textContent = String(currentMoves);

  if (currentMoves <= DANGER_THRESH) { ui.current.classList.add('danger'); subtleShake(ui.current); }
  else ui.current.classList.remove('danger');

  const max = state.maxEstimate || 0;
  const goal = Math.max(1,max);
  const pct = Math.min(100, Math.round((state.chain.length-1)/goal*100));
  ui.progFill.style.width = pct + "%";
  ui.maxLine.textContent = max ? "Max today " + max : "Max today ?";
  ui.maxToday.textContent = max ? String(max) : "?";
  ui.bigMaxN.textContent = ui.maxToday.textContent;
}
function setCurrent(w){ ui.current.textContent=w.toUpperCase(); setCounts(w); }
function showMsg(text, ok=false){
  ui.msg.textContent=text; ui.msg.className="small msg " + (ok? "ok":"bad");
  setTimeout(()=>{ if(ui.msg.textContent===text){ ui.msg.textContent=""; ui.msg.className="small msg"; } }, 1100);
}
function updatePB(){
  const sc = state.chain.length-1;
  const prev = parseInt(localStorage.getItem("tx_pb_chain")||"0",10);
  if(sc>prev){ localStorage.setItem("tx_pb_chain", String(sc)); AudioFX.fanfare(); FX.burst(innerWidth*0.5, 120); }
  ui.pb.textContent = String(Math.max(prev, sc));
}

/* longest chain estimate */
function computeMaxQuick(){
  const words=currentDict(), idx=new Map(words.map((w,i)=>[w,i]));
  const adj=words.map(_=>[]);
  for(let i=0;i<words.length;i++){ const w=words[i]; const nbs=neighborsOf(w); for(const v of nbs){ const j=idx.get(v); if(j!=null) adj[i].push(j); } }
  const startIdx = idx.get(state.start); if(startIdx==null) return 0;
  const seen=new Uint8Array(words.length); let best=1;
  function order(nbs){ return nbs.sort((a,b)=>adj[a].length - adj[b].length); }
  function dfs(i,d,limit){ if(d>best) best=d; if(limit<=0) return; seen[i]=1; const nbs=order(adj[i].filter(j=>!seen[j])); for(const j of nbs) dfs(j,d+1,limit-1); seen[i]=0; }
  dfs(startIdx,1,1200);
  return Math.max(0,best-1);
}

/* daily start */
function pickDailyStart(){
  const candidates = currentDict().filter(w=>neighborsOf(w).length>=2);
  return candidates.length ? seededPick(candidates, ymd()+":"+currentDict().length) : currentDict()[0] || "about";
}

/* start and play */
function startRound(){
  state.key = ymd();
  state.start = pickDailyStart();
  state.chain = [state.start];
  state.used = new Set([state.start]);
  ui.chain.innerHTML="";
  addPill(state.start,true);
  setCurrent(state.start);
  ui.score.textContent = "0";
  ui.msg.textContent="";
  ui.guess.value="";
  ui.guess.focus();
  const d = new Date(); ui.date.textContent = d.toLocaleDateString();
  state.maxEstimate = computeMaxQuick();
  setCounts(state.start);
  const prev = parseInt(localStorage.getItem("tx_pb_chain")||"0",10);
  ui.pb.textContent = String(prev);
}

/* live hinting before Enter */
function previewWord(raw){
  const w = norm(raw);
  const last = state.chain[state.chain.length-1];
  if(!w){ ui.hint.textContent=""; return; }
  if(!is5(w)){ ui.hint.textContent="Type five letters"; ui.hint.className="hintline hint-bad"; return; }
  if(!dictIncludes(w)){ ui.hint.textContent="Not in word list"; ui.hint.className="hintline hint-bad"; return; }
  if(state.used.has(w)){ ui.hint.textContent="Already used in your chain"; ui.hint.className="hintline hint-bad"; return; }
  if(!ham1(last,w)){ ui.hint.textContent="Must change exactly one letter from "+last.toUpperCase(); ui.hint.className="hintline hint-bad"; return; }
  const nbs = neighborsOf(w).filter(v=>!state.used.has(v) && v!==last);
  const count = nbs.length;
  if(count===0){ ui.hint.textContent="Valid, but likely a dead end (opens 0 new words)"; ui.hint.className="hintline hint-warn"; return; }
  if(count<=2){ ui.hint.textContent="Valid, but tight branch (opens "+count+")"; ui.hint.className="hintline hint-warn"; return; }
  ui.hint.textContent = "Valid. This move would open "+count+" next words";
  ui.hint.className = "hintline hint-ok";
}

/* commit a move */
function tryPlay(raw){
  const next = norm(raw);
  const last = state.chain[state.chain.length-1];
  if(!is5(next)){ showMsg("Type five letters"); AudioFX.buzz(); navigator.vibrate?.(25); return; }
  if(!dictIncludes(next)){ showMsg("Not in word list"); AudioFX.buzz(); navigator.vibrate?.([20,30,20]); return; }
  if(state.used.has(next)){ showMsg("Already used"); AudioFX.buzz(); return; }
  if(!ham1(last,next)){ showMsg("Change exactly one letter"); AudioFX.buzz(); return; }
  state.chain.push(next); state.used.add(next); addPill(next);
  ui.score.textContent = String(state.chain.length-1);
  setCurrent(next);
  ui.hint.textContent = "";
  showMsg("ok",true); AudioFX.chord([440,554,659],.18); FX.burst(innerWidth*0.5, 90, 40);
  ui.guess.value=""; ui.guess.focus();
  updatePB();
}

/* end round */
function endRound(){
  state.maxEstimate = computeMaxQuick();
  setCounts(state.chain[state.chain.length-1]);
  showMsg("Round complete", true);
  AudioFX.fanfare(); FX.burst(innerWidth*0.5, innerHeight*0.3, 220);
}

/* countdown */
const Timer = {
  on:false,
  tick(){
    if(!Timer.on) return;
    const now=new Date(); const next=new Date(now); next.setHours(24,0,0,0);
    const ms=Math.max(0,next-now);
    const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000);
    ui.countdown.textContent="Next puzzle in "+String(h).padStart(2,'0')+":"+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
    requestAnimationFrame(Timer.tick);
  }
};

/* sharing */
function shareText(){
  const d = ymd();
  const score = state.chain.length-1;
  const max = state.maxEstimate ?? "?";
  const start = state.start?.toUpperCase() || "?????";
  return `Transformations ${d}  start ${start}  score ${score}  max ${max}  ${SITE_URL}`;
}
function copyShare(){
  const t = shareText();
  navigator.clipboard?.writeText(t).then(()=>showMsg("Copied",true)).catch(()=>showMsg("Copy failed"));
}
function shareWeb(){
  const t = shareText();
  if(navigator.share){ navigator.share({title:"Transformations", text:t, url:SITE_URL}).catch(()=>{}); }
  else { copyShare(); }
}
function openX(){
  const url = "https://twitter.com/intent/tweet?text="+encodeURIComponent(shareText());
  window.open(url,"_blank");
}
function openFB(){
  const url = "https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(SITE_URL)+"&quote="+encodeURIComponent(shareText());
  window.open(url,"_blank");
}
function storyImageDataURL(){
  const W=1080,H=1920;
  const c=document.createElement("canvas"); c.width=W; c.height=H; const ctx=c.getContext("2d");
  const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,"#ffffff"); g.addColorStop(1,"#eaf2ff"); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.fillStyle="#0b84ff"; ctx.fillRect(80, 560, W-160, 18);
  const score = state.chain.length-1, max = state.maxEstimate||0; const pct = max? Math.min(1, score/max):0;
  ctx.fillStyle="#ff6a00"; ctx.fillRect(80, 560, Math.round((W-160)*pct), 18);
  ctx.fillStyle="#1b1f29"; ctx.font="900 84px Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial"; ctx.fillText("TRANSFORMATIONS", 80, 200);
  ctx.font="28px Inter, system-ui"; ctx.fillText(ymd(), 80, 240);
  ctx.font="48px Inter, system-ui"; ctx.fillText("Start "+(state.start||"").toUpperCase(), 80, 340);
  ctx.font="72px Inter, system-ui"; ctx.fillText("Score "+score+(max?(" / "+max):""), 80, 430);
  ctx.font="28px Inter, system-ui"; ctx.fillText(SITE_URL, 80, H-80);
  let x=80,y=660;
  for(const w of state.chain){
    ctx.fillStyle="#0b84ff"; ctx.beginPath(); const r=14, ww=48+ w.length*22; if(ctx.roundRect) ctx.roundRect(x,y,ww,44,r); else ctx.rect(x,y,ww,44); ctx.fill();
    ctx.fillStyle="#fff"; ctx.font="600 28px Inter, system-ui"; ctx.fillText(w.toUpperCase(), x+16, y+30);
    x+=ww+12; if(x>W-200){ x=80; y+=60; }
  }
  return c.toDataURL("image/png");
}
function downloadStory(){
  const url = storyImageDataURL();
  const a=document.createElement("a"); a.href=url; a.download="transformations-story.png"; document.body.appendChild(a); a.click(); a.remove();
}

/* friend leaderboard */
function buildFriendBoard(){
  const lines = ui.friendInput.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const rows = [];
  for(const ln of lines){
    const m = ln.match(/Transformations\s+(\d{4}-\d{2}-\d{2}).*?start\s+([A-Za-z]{5}).*?score\s+(\d+).*?(?:max\s+(\d+))?.*?(?:by\s+(.+))?$/i);
    if(m){ rows.push({date:m[1], start:m[2].toUpperCase(), score:parseInt(m[3],10)||0, max:m[4]?parseInt(m[4],10):null, who:(m[5]||"friend").trim()}); }
  }
  rows.sort((a,b)=>b.score-a.score);
  ui.friendBoard.innerHTML = rows.length? "<b>Leaderboard</b><br>"+rows.map((r,i)=>`${i+1}. ${r.who}  score ${r.score}${r.max? " of "+r.max:""}  start ${r.start}`).join("<br>") : "No valid lines yet";
}

/* events */
ui.enter.addEventListener("click", ()=> tryPlay(ui.guess.value));
ui.guess.addEventListener("keydown", e=>{ if(e.key==="Enter") tryPlay(ui.guess.value); });
ui.guess.addEventListener("input", e=> previewWord(e.target.value));
ui.end.addEventListener("click", endRound);
ui.reset.addEventListener("click", ()=>{ buildIndex(); startRound(); ui.hint.textContent=""; });
ui.timerSwitch.addEventListener("change", ()=>{ Timer.on = ui.timerSwitch.checked; ui.countdown.style.display = Timer.on? "block":"none"; if(Timer.on) Timer.tick(); });
ui.copy.addEventListener("click", copyShare);
ui.webshare.addEventListener("click", shareWeb);
ui.x.addEventListener("click", openX);
ui.fb.addEventListener("click", openFB);
ui.story.addEventListener("click", downloadStory);
ui.sound.addEventListener("click", ()=>{ soundOn=!soundOn; ui.sound.textContent = soundOn? "Sound on":"Sound off"; });
ui.dictBtn.addEventListener("click", ()=>{
  USE_LENIENT = !USE_LENIENT;
  ui.dictBtn.textContent = "Lenient: " + (USE_LENIENT ? "On" : "Off");
  dictIncludes._sets = {};
  buildIndex();
  setCounts(state.chain[state.chain.length-1]);
  previewWord(ui.guess.value);
  showMsg(USE_LENIENT ? "Lenient dictionary enabled" : "Standard dictionary", true);
});
ui.friendParse.addEventListener("click", buildFriendBoard);
ui.themePick.addEventListener("change", e=>applyTheme(e.target.value));

/* init */
applyTheme(localStorage.getItem('tx_theme') || 'light');
loadDictionaries().then(()=>{
  buildIndex();
  startRound();
}).catch(()=>{
  buildIndex();
  startRound();
});
</script>
</body>
</html>
